<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Web3 -->
    <script src="bower_components/web3/dist/web3.min.js"></script>
    <script type="text/javascript" src="bower_components/bignumber.js/bignumber.min.js"></script>
    <!-- SQL Server -->
    <script src="bower_components/mssql/bin/mssql"></script>

    <!-- Ethereum connection -->
    <script type="text/javascript">
        var Web3 = require('web3');
        if (typeof web3 !== 'undefined') {
            web3 = new Web3(web3.currentProvider);
        } else {
            // set the provider you want from Web3.providers
            web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
        }

        var source = "" +
        "contract Container {\n" +
        "   uint public id;\n" +
        "   string public contentDescription;\n" +
        "   enum State { Sent, ApprovedForShipping, Loaded, ApprovedForCollecting, Collected }\n"+
        "   State public currentState;\n"+
        "   address public owner;\n"+
        "   mapping (address => bool) public whitelist;\n"+
        "modifier isWhitelisted {\n"+
        "    if (whitelist[msg.sender] == false) throw;\n"+
        "    _\n"+
        "}\n"+
        "function Container(){\n"+
        "    whitelist[msg.sender] = true;\n"+
        "    owner = msg.sender;\n"+
        "}\n"+
        "function specifyLoading(string description, uint newId) isWhitelisted {\n"+
        "    contentDescription = description;\n"+
        "    id = newId;\n"+
        "}\n"+
        "function send() isWhitelisted {\n"+
        "    currentState = State.Sent;\n"+
        "}\n"+
        "function approveForShipping() isWhitelisted {\n"+
        "    currentState = State.ApprovedForShipping;\n"+
        "}\n"+
        "function load() isWhitelisted {\n"+
        "    currentState = State.Loaded;\n"+
        "}\n"+
        "function approvForCollecting() isWhitelisted {\n"+
        "    currentState = State.ApprovedForShipping;\n"+
        "}\n"+
        "function collect() isWhitelisted {\n"+
        "    currentState = State.ApprovedForCollecting;\n"+
        "}\n"+
        "function addToWhitelist(address Party) isWhitelisted {\n"+
        "    whitelist[Party] = true;\n"+
        "}\n"+
        "function removefromWhitelist(address Party) isWhitelisted {\n"+
        "    whitelist[Party] = false;\n"+
        "}\n"+
        "function updateOwnership(address newOwner) isWhitelisted {\n"+
        "    owner = newOwner;\n"+
        "}\n"+
        "}\n";
        console.log(source);
        var compiled = web3.eth.compile.solidity(source);
        console.log(compiled);
        var code = compiled.test.code;
        console.log(code);
        // contract json abi, this is autogenerated using solc CLI
        var abi = compiled.test.info.abiDefinition;
        console.log(abi);
        var myContract;

        function watchBalance() {
            var coinbase = web3.eth.coinbase;
            var originalBalance = web3.eth.getBalance(coinbase).toNumber();
            document.getElementById('coinbase').innerText = 'coinbase: ' + coinbase;
            document.getElementById('original').innerText = ' original balance: ' + originalBalance + '    watching...';
            web3.eth.filter('latest').watch(function() {
                var currentBalance = web3.eth.getBalance(coinbase).toNumber();
                document.getElementById("current").innerText = 'current: ' + currentBalance;
                document.getElementById("diff").innerText = 'diff:    ' + (currentBalance - originalBalance);
            });
        }

        function addContainer() {
            var containerId = document.getElementById("containerId").value;
            var containerOwner = document.getElementById("containerOwner").value;
            var ownerAddress = web3.eth.coinbase;

            // let's assume that coinbase is our account
            web3.eth.defaultAccount = web3.eth.coinbase;

            // create contract
            document.getElementById('status').innerText = "transaction sent, waiting for confirmation";
            web3.eth.contract(abi).new({data: code}, function (err, contract) {
                if(err) {
                    console.error(err);
                    return;
                // callback fires twice, we only want the second call when the contract is deployed
                } else if(contract.address){
                    myContract = contract;
                    console.log('address: ' + myContract.address);
                    document.getElementById('status').innerText = 'Mined!';
                }
            });
        }

        function getContainer() {
            var sql = require("mssql");

            // config for your database
            var config = {
                user: 'HackSQL2',
                password: 'M@rskH@ckSQL2016',
                server: 'maerskhackathonsql.database.windows.net ',
                database: 'HackSQL2'
            };

            // connect to your database
            sql.connect(config, function (err) {

                if (err) console.log(err);

                // create Request object
                var request = new sql.Request();

                // query to the database and get the records
                request.query('SELECT top 1 equipment_no FROM freighthereum.container WHERE address IS NULL AND container_status = 1;', function (err, recordset) {

                    if (err) console.log(err)

                    // send records as a response
                    res.send(recordset);

                });
            });
        }
    </script>
  </head>
  <body>
    <h1>Coinbase Balance</h1>
    <button type="button" onClick="watchBalance();">Watch balance</button>
    <div></div>
    <div id="coinbase"></div>
    <div id="original"></div>
    <div id="current"></div>
    <div id="diff"></div>

    <h1>Freight Forwarder</h1>
    <input id="containerId" placeholder="containerId" type="text">
    <input id="containerOwner" placeholder="containerOwner" type="text">
    <button type="button" onClick="addContainer();">Create new container</button>
    <div id="status"></div>
    <div></div>
    <div></div>

    <h1>Database Connection</h1>
    <button type="button" onClick="getContainer();">Get Container</button>


    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  </body>
</html>
